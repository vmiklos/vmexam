#!/bin/bash

# Runs astyle-check/pep8/etc on each file, which is tracked as an "indented file".

cdup=$(git rev-parse --show-cdup)

[ -n "$cdup" ] && cd $cdup

fix=
if [ "$1" == "--fix" ]; then
	fix=y
	shift
fi

for file in $(cat .git/indented-files.cache)
do
	case $file in
	*.cxx|*.cpp|*.hxx)
		if ! astyle-check $file; then
			if [ -n "$fix" ]; then
				astyle-check --fix $file
			else
				exit 1
			fi
		fi
		find-unsorted-includes $file || exit 1
		# Use css:: instead.
		grep -H -n com::sun::star:: $file && exit 1
		;;
	*.py)
		pep8 --ignore=E501 $file || exit 1

		if echo $file |grep -q /uitest/; then
			continue
		fi

		lint=$(pylint $file 2>/dev/null | egrep -i 'unused|indent')
		if [ -n "$lint" ]; then
			echo "$file"
			echo "$lint"
			exit 1
		fi
		;;
	*)
		echo "unexpected extension for file: $file"
		exit 1
	;;
	esac
done

exit 0
