#!/usr/bin/env python

# Dumb script which just tries to uncomment each include to see if it causes a
# build failure.

import sys, os
import includetools

def comment_line(lines, linenum):
	lines[linenum] = "//%s" % lines[linenum]
	with open(srcfile, "w") as sock:
		sock.write("".join(lines))
	return lines

def uncomment_line(lines, linenum):
	assert lines[linenum][:2] == "//"
	lines[linenum] = lines[linenum][2:]
	with open(srcfile, "w") as sock:
		sock.write("".join(lines))
	return lines

try:
	buildcmd = sys.argv[1]
except IndexError:
	print """Example: find-unneeded-includes 'make -sr build -j8' source/filter/ww8/rtfsdrexport.cxx"""
	sys.exit(1)
srcfile = sys.argv[2]

sock = open(srcfile)
lines = sock.readlines()
sock.close()

for i, line in enumerate(lines):
	if not line.startswith("#include"):
		continue
	what = line.strip().replace("#include ", "")
	if what in includetools.stdCppHeaders:
		continue
	lines = comment_line(lines, i)
	if os.system(buildcmd) != 0:
		lines = uncomment_line(lines, i)
